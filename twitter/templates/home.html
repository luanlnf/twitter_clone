{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="container mt-4">
    <div class="row">

        <!-- TIMELINE -->
        <div class="col-md-8">
            <h3 class="mb-4">Tweets</h3>

            {% for tweet in tweets %}
                <div class="card shadow-sm mb-3">
                <div class="card-body d-flex">

                    <!-- Profile Picture -->
                    <div class="me-3 text-center">
                        <a href="{% url 'profile' tweet.user.id %}">
                            {% if tweet.user.profile.profile_image %}
                                <img src="{{ tweet.user.profile.profile_image.url }}"
                                    class="rounded-circle" width="55" height="55">
                            {% else %}
                                <img src="{% static 'images/default_profile_pic.png' %}"
                                    class="rounded-circle" width="55" height="55">
                            {% endif %}
                        </a>
                    </div>

                    <!-- Tweet + Comments -->
                    <div style="width:100%;">

                        <!-- Tweet body -->
                        <p class="mb-1">{{ tweet.body }}</p>

                        <small class="text-muted">
                            {{ tweet.created_at }} —
                            @{{ tweet.user.username }} —
                           <span class="d-inline-flex align-items-center gap-1">
                                {% if user in tweet.likes.all %}
                                    <a href="{% url 'tweet_like' tweet.id %}"
                                    class="text-decoration-none text-danger d-flex align-items-center gap-1">
                                    <i class="fa-solid fa-heart"></i>
                                    <span>{{ tweet.number_of_likes }}</span>
                                    <span>Likes</span>
                                    </a>
                                {% else %}
                                    <a href="{% url 'tweet_like' tweet.id %}"
                                    class="text-decoration-none text-muted d-flex align-items-center gap-1">
                                    <i class="fa-regular fa-heart"></i>
                                    <span>{{ tweet.number_of_likes }}</span>
                                    <span>Likes</span>
                                    </a>
                                {% endif %}

                                </span>
                            <!-- Comment Icon -->
                            <span class="ms-3 d-inline-flex align-items-center gap-1 tweet-action toggle-comments"
                                    data-tweet-id="{{ tweet.id }}"
                                    style="cursor:pointer;">
                                <i class="fa-regular fa-comment"></i>
                                <span>{{ tweet.number_of_comments }}</span>
                                <span>Comments</span>
                            </span>
                        </small>

                        <!-- COMMENTS -->
                        <div id="comments-{{ tweet.id }}"
                            class="mt-3 ps-3 border-start comments-section d-none">


                            {% for comment in tweet.comments.all %}
                                <div class="d-flex gap-2 mb-2">

                                    {% if comment.user.profile.profile_image %}
                                        <img
                                            src="{{ comment.user.profile.profile_image.url }}"
                                            class="rounded-circle"
                                            width="35"
                                            height="35"
                                        />
                                    {% else %}
                                        <img
                                            src="{% static 'images/default_profile_pic.png' %}"
                                            class="rounded-circle"
                                            width="35"
                                            height="35"
                                        />
                                    {% endif %}

                                    <div class="bg-light rounded p-2 w-100">
                                        <small class="fw-bold">
                                            {{ comment.user.username }}
                                            <span class="text-muted">
                                                @{{ comment.user.username|lower }}
                                            </span>
                                        </small>

                                        <p class="mb-1 small">{{ comment.body }}</p>

                                        <small class="text-muted">
                                            {{ comment.created_at|date:"d M Y H:i" }}
                                        </small>
                                    </div>
                                </div>
                            {% empty %}
                                <small class="text-muted">Ainda não há comentários</small>
                            {% endfor %}

                        </div>

                        <!-- ADD COMMENT -->
                        <form method="POST"
                            action="{% url 'add_comment' tweet.id %}"
                            class="mt-2 ps-3">
                            {% csrf_token %}
                            <div class="d-flex gap-2">
                                <textarea
                                    name="body"
                                    class="form-control comment-input"
                                    rows="2"
                                    placeholder="Tweet seu comentário"
                                    required
                                ></textarea>

                                <button class="btn btn-outline-primary">
                                    Comentar
                            
                                </button>
                            </div>
                        </form>

                    </div>
                </div>
            </div>

            {% endfor %}
        </div>

        <!-- POST TWEET -->
        <div class="col-md-4">
            {% if form %}
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="mb-3">Postar Tweet</h5>

                    <form method="POST">
                        {% csrf_token %}
                        {{ form.as_p }}
                        <button class="btn btn-primary w-100 mt-2">Postar</button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>

    </div>
</div>
{% endblock %}
